name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to Server
        run: |
          ssh root@45.32.102.242 << 'ENDSSH'
          set -e

          echo "ðŸ“¦ Deploying to production..."

          # Go to deployment directory
          cd ~/deployment

          # Pull latest code
          echo "â¬‡ï¸  Pulling latest code..."
          git pull origin main

          # Deploy Backend
          echo "ðŸ”§ Deploying backend..."
          cd ~/deployment/clinic-backend
          composer install --optimize-autoloader --no-dev --no-interaction
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan storage:link
          php artisan queue:restart

          echo "âœ… Deployment completed!"
          ENDSSH

      - name: Notify
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
